on:
  push:
    tags:
      - '*'

name: release
jobs:
    release:
        name: run goreleaser
        runs-on: ubuntu-latest
        steps:
          - name: git checkout
            uses: actions/checkout@v2
            with:
              fetch-depth: 0

          - name: install go
            uses: actions/setup-go@v2
            with:
              go-version: '1.16.3'

          - name: OSXCross for CGO Support
            run: |
              mkdir ../../osxcross
              git clone https://github.com/plentico/osxcross-target.git ../../osxcross/target

          - name: Downgrade libssl
            run: |
              echo 'deb http://security.ubuntu.com/ubuntu bionic-security main' | sudo tee -a /etc/apt/sources.list
              sudo apt update && apt-cache policy libssl1.0-dev
              sudo apt-get install libssl1.0-dev

          - name: Set up MinGW
            uses: egor-tensin/setup-mingw@v2
            with:
             platform: x64

          - name: Run GoReleaser
            uses: goreleaser/goreleaser-action@v2
            with:
              version: latest
              args: release --rm-dist
            env:
              GITHUB_TOKEN: ${{ secrets.GORELEASER_TOKEN }}
